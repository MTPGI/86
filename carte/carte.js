var map = L.map('mymap', {
  zoomSnap: 0.5
}).setView([46.60090935180355, 0.5818611371071515], 9.5);

var 
light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  minZoom: 9.5,
  maxZoom: 18
}),
geom = {
  "type":"Polygon",
  "coordinates":[[[0.402781,46.063135],[0.39846,46.064672],[0.389865,46.067125],[0.381789,46.063386],[0.353065,46.065062],[0.349228,46.063888],[0.345032,46.063752],[0.331229,46.065046],[0.322534,46.062416],[0.314406,46.065097],[0.31088,46.062558],[0.291341,46.059551],[0.276894,46.061088],[0.273546,46.067246],[0.256443,46.078704],[0.242226,46.080844],[0.234951,46.08538],[0.233006,46.087531],[0.226685,46.090086],[0.223655,46.092522],[0.197179,46.095381],[0.193886,46.096893],[0.190729,46.104799],[0.188855,46.111315],[0.200004,46.11744],[0.204106,46.122747],[0.203045,46.125733],[0.198497,46.126836],[0.200566,46.129862],[0.216323,46.142138],[0.218943,46.155373],[0.213335,46.159048],[0.198315,46.159935],[0.186817,46.149312],[0.176943,46.150132],[0.171886,46.155832],[0.16768,46.156083],[0.155125,46.157174],[0.153854,46.160425],[0.148121,46.172574],[0.139639,46.17961],[0.107711,46.185996],[0.109512,46.189129],[0.113446,46.212212],[0.11806,46.213192],[0.131328,46.226836],[0.135887,46.225736],[0.1427,46.230451],[0.140725,46.236982],[0.13948,46.240216],[0.137472,46.244992],[0.130095,46.264056],[0.12885,46.267236],[0.133606,46.266788],[0.162062,46.267545],[0.172329,46.278605],[0.170342,46.284165],[0.152954,46.304065],[0.165013,46.305511],[0.169495,46.310682],[0.165955,46.317059],[0.177376,46.328114],[0.175258,46.331376],[0.156201,46.343279],[0.137604,46.3494],[0.123334,46.346791],[0.11796,46.340899],[0.101374,46.333085],[0.095538,46.327453],[0.096939,46.320559],[0.078229,46.304941],[0.047183,46.322409],[0.029366,46.328682],[0.015112,46.326258],[0.022478,46.342159],[0.030371,46.346056],[0.013864,46.357015],[0.016619,46.359476],[0.034226,46.373497],[0.029948,46.375031],[0.022449,46.379207],[0.014682,46.390831],[0.000468,46.392258],[-0.007992,46.389059],[-0.0077,46.39253],[-0.012689,46.402022],[-0.020208,46.405881],[-0.012757,46.425883],[-0.010581,46.449888],[-0.01923,46.453273],[-0.017843,46.456407],[-0.010453,46.468333],[-0.012521,46.471279],[-0.013582,46.474417],[-0.040098,46.470067],[-0.043252,46.472441],[-0.042527,46.482356],[-0.032156,46.488649],[-0.039219,46.49311],[-0.038779,46.499718],[-0.031176,46.508291],[-0.031344,46.524984],[-0.006263,46.523973],[-0.00493,46.527223],[0.007111,46.545346],[-0.010103,46.555443],[-0.003303,46.57173],[0.020525,46.584646],[0.030612,46.585031],[0.038239,46.589569],[0.042729,46.591171],[0.024007,46.595113],[0.025814,46.605095],[0.021698,46.61124],[0.022864,46.614531],[0.003193,46.611457],[-0.010048,46.616559],[0.000436,46.639699],[-0.004891,46.644702],[-0.017194,46.639408],[-0.028194,46.628533],[-0.060914,46.622755],[-0.065803,46.622823],[-0.064741,46.632756],[-0.03413,46.654323],[-0.037854,46.663805],[-0.032039,46.669254],[-0.031651,46.669352],[-0.028941,46.672261],[-0.009272,46.682442],[-0.018146,46.693978],[0,46.699401],[0.002549,46.705807],[-0.000545,46.715897],[0.003791,46.71765],[0.007304,46.719927],[0.022874,46.727678],[0.031913,46.727177],[0.03676,46.728624],[0.038065,46.73118],[0.033067,46.738496],[0.028176,46.738982],[-0.001919,46.761285],[-0.012659,46.754351],[-0.015762,46.757059],[-0.02187,46.776348],[-0.01771,46.778018],[-0.022654,46.789518],[-0.009541,46.798932],[-0.007056,46.801764],[0.006718,46.810298],[0.00692,46.813516],[-0.004124,46.819384],[-0.006885,46.821973],[-0.013081,46.816419],[-0.022464,46.814218],[-0.030215,46.818757],[-0.045199,46.820776],[-0.049087,46.823036],[-0.045394,46.824004],[-0.045686,46.832108],[-0.035502,46.832571],[-0.025771,46.840621],[-0.007801,46.846661],[0.002083,46.845],[0.014994,46.83457],[0.016616,46.834963],[0.019136,46.837669],[0.033768,46.854075],[0.02375,46.853946],[0.010114,46.858601],[0.00168,46.862488],[-0.008087,46.870425],[-0.022409,46.8741],[-0.032215,46.872341],[-0.035636,46.874934],[-0.031582,46.876755],[-0.023034,46.888065],[-0.023206,46.894695],[-0.009117,46.907927],[-0.010292,46.911413],[-0.013862,46.92187],[-0.015036,46.925275],[-0.022141,46.938117],[-0.030725,46.941774],[-0.031339,46.945289],[-0.033922,46.951995],[-0.044836,46.959519],[-0.046251,46.966518],[-0.043479,46.969258],[-0.033116,46.980246],[-0.033892,46.983533],[-0.03871,46.989284],[-0.055323,46.994636],[-0.060313,46.994425],[-0.086473,46.985297],[-0.084953,46.988632],[-0.092374,47.005288],[-0.093046,47.008496],[-0.082628,47.010039],[-0.081249,47.013012],[-0.088266,47.025041],[-0.08896,47.027592],[-0.090257,47.032694],[-0.091414,47.03789],[-0.092176,47.041348],[-0.102114,47.0648],[-0.104087,47.071401],[-0.100642,47.084587],[-0.099984,47.088084],[-0.098051,47.091347],[-0.088888,47.098272],[-0.085545,47.100431],[-0.068736,47.096527],[-0.067765,47.093379],[-0.044231,47.093148],[-0.039927,47.087612],[-0.035315,47.086718],[-0.027071,47.102673],[-0.028049,47.106028],[-0.037488,47.108138],[-0.039508,47.114747],[-0.034441,47.120621],[-0.034008,47.127226],[-0.010646,47.157468],[0.015531,47.173298],[0.019015,47.175753],[0.033624,47.162888],[0.036634,47.160357],[0.051059,47.167123],[0.053739,47.164612],[0.064923,47.146078],[0.068953,47.14406],[0.078394,47.146334],[0.079872,47.120633],[0.08243,47.117794],[0.090198,47.121852],[0.104718,47.120794],[0.110325,47.12929],[0.123964,47.126934],[0.127954,47.120999],[0.137316,47.122258],[0.140688,47.12459],[0.134135,47.115268],[0.134946,47.108372],[0.158611,47.102738],[0.16192,47.10011],[0.167834,47.108357],[0.179245,47.11336],[0.183482,47.11451],[0.185353,47.104043],[0.197799,47.089408],[0.174504,47.07074],[0.17673,47.064193],[0.175696,47.060727],[0.180345,47.059455],[0.194399,47.063004],[0.208194,47.053234],[0.228062,47.061322],[0.232841,47.066386],[0.235156,47.069164],[0.243872,47.070943],[0.263552,47.068509],[0.26422,47.046429],[0.267683,47.044044],[0.294502,47.051948],[0.298428,47.05397],[0.307898,47.047271],[0.309067,47.031301],[0.309941,47.028031],[0.300596,47.021108],[0.305155,47.002488],[0.308174,46.999923],[0.310731,46.997304],[0.296086,46.990161],[0.291441,46.990267],[0.306585,46.978928],[0.29821,46.971264],[0.306415,46.963931],[0.303024,46.958355],[0.302035,46.955314],[0.310574,46.939707],[0.321022,46.932628],[0.325355,46.93095],[0.343125,46.936704],[0.348079,46.936368],[0.364632,46.948568],[0.382824,46.94375],[0.387819,46.943709],[0.401144,46.938193],[0.405371,46.936132],[0.420745,46.936389],[0.434523,46.93167],[0.438708,46.929579],[0.443886,46.938114],[0.444804,46.941152],[0.486472,46.954017],[0.49129,46.955319],[0.502574,46.957794],[0.505196,46.959906],[0.512904,46.955862],[0.549552,46.959588],[0.554202,46.958473],[0.563308,46.955771],[0.598218,46.956431],[0.6017,46.958886],[0.598803,46.974922],[0.576877,46.98087],[0.573692,46.983385],[0.57315,46.989468],[0.57438,46.992439],[0.567923,46.999664],[0.566947,47.002538],[0.567744,47.006284],[0.585903,47.006104],[0.590553,47.006723],[0.618494,47.007514],[0.623657,47.002417],[0.621897,46.999412],[0.623985,46.993684],[0.63356,46.986655],[0.637799,46.985251],[0.646803,46.988255],[0.655894,46.985185],[0.660466,46.978989],[0.69017,46.974983],[0.69491,46.965719],[0.695173,46.962242],[0.695984,46.959373],[0.706178,46.936114],[0.70318,46.925822],[0.708928,46.917725],[0.703745,46.909364],[0.704675,46.90289],[0.727287,46.886094],[0.729474,46.883182],[0.739267,46.872855],[0.743531,46.871591],[0.753433,46.860589],[0.765645,46.865121],[0.771805,46.861264],[0.766361,46.855844],[0.771396,46.850955],[0.795017,46.850521],[0.796642,46.847348],[0.78689,46.841231],[0.794669,46.832897],[0.808005,46.829135],[0.809046,46.819214],[0.809861,46.815896],[0.810172,46.81419],[0.815608,46.805004],[0.81335,46.791675],[0.826104,46.786822],[0.829407,46.776869],[0.844854,46.763016],[0.858733,46.759157],[0.859744,46.755723],[0.865606,46.751039],[0.867476,46.748219],[0.879814,46.738749],[0.898334,46.735799],[0.902835,46.730402],[0.911181,46.727079],[0.910415,46.717414],[0.921593,46.702724],[0.924824,46.700217],[0.927141,46.693606],[0.918161,46.69049],[0.902273,46.677665],[0.907255,46.678134],[0.911846,46.672594],[0.907342,46.666437],[0.915637,46.650677],[0.907639,46.646726],[0.895521,46.631825],[0.894011,46.628657],[0.904907,46.618177],[0.908486,46.605281],[0.916285,46.597127],[0.933296,46.594567],[0.937765,46.594425],[0.935692,46.588729],[0.939364,46.583492],[0.941376,46.580882],[0.955605,46.577617],[0.962441,46.572543],[0.982021,46.573273],[0.990591,46.566031],[1.009905,46.567418],[1.014776,46.567764],[1.024724,46.549712],[1.020412,46.537146],[1.065517,46.53926],[1.080128,46.536183],[1.090096,46.537588],[1.104156,46.533431],[1.119421,46.524229],[1.123727,46.522322],[1.146915,46.505183],[1.149156,46.50221],[1.145333,46.500074],[1.136832,46.49678],[1.139754,46.487157],[1.152963,46.472845],[1.135516,46.470889],[1.150929,46.450301],[1.163788,46.446773],[1.168536,46.446354],[1.185486,46.439517],[1.185846,46.429309],[1.195482,46.429613],[1.20337,46.433803],[1.213067,46.433081],[1.211273,46.429923],[1.193414,46.409761],[1.195401,46.400018],[1.177288,46.383953],[1.173139,46.385224],[1.15702,46.389233],[1.155321,46.386039],[1.148522,46.377069],[1.149086,46.370281],[1.128584,46.362228],[1.129866,46.358939],[1.127763,46.348866],[1.109447,46.353834],[1.101418,46.362367],[1.077304,46.358548],[1.072734,46.359478],[1.050172,46.362788],[1.050978,46.359485],[1.027177,46.343448],[1.026155,46.340044],[1.026225,46.323101],[1.021189,46.313297],[1.009909,46.306669],[1.009571,46.296615],[1.003758,46.291175],[1.005903,46.280978],[1.00339,46.280228],[0.999828,46.282616],[0.990078,46.283778],[0.986252,46.281591],[0.972566,46.28553],[0.952808,46.285633],[0.935336,46.291249],[0.934189,46.281328],[0.929202,46.28096],[0.901269,46.287511],[0.889714,46.268557],[0.861649,46.261824],[0.863368,46.258715],[0.85774,46.249544],[0.848319,46.248269],[0.843569,46.238884],[0.85191,46.235961],[0.851565,46.232457],[0.843536,46.22921],[0.808406,46.228004],[0.799371,46.215499],[0.794758,46.21405],[0.796469,46.211293],[0.801427,46.207392],[0.800232,46.201481],[0.803922,46.1993],[0.813337,46.19769],[0.821178,46.185513],[0.833309,46.180644],[0.82871,46.172168],[0.831435,46.170226],[0.838214,46.165727],[0.832425,46.156345],[0.83576,46.146194],[0.845864,46.138373],[0.840129,46.133672],[0.837021,46.130895],[0.823444,46.12859],[0.82025,46.131283],[0.808291,46.136809],[0.785206,46.131068],[0.747901,46.138721],[0.729225,46.135073],[0.725137,46.13632],[0.712347,46.138971],[0.71191,46.138425],[0.710522,46.131575],[0.685609,46.120739],[0.676463,46.112542],[0.687457,46.097261],[0.682517,46.097216],[0.648823,46.094665],[0.640105,46.0917],[0.620579,46.093178],[0.613623,46.088572],[0.608982,46.089744],[0.606073,46.08357],[0.607368,46.077795],[0.595686,46.072665],[0.594839,46.07573],[0.590864,46.081167],[0.574111,46.078134],[0.563228,46.089151],[0.553343,46.090038],[0.539987,46.085562],[0.538894,46.08891],[0.53694,46.095628],[0.521034,46.112616],[0.504336,46.11933],[0.508689,46.131946],[0.504163,46.13298],[0.495243,46.135291],[0.486258,46.128089],[0.472313,46.130137],[0.466946,46.117503],[0.455716,46.106904],[0.451137,46.108006],[0.446461,46.103662],[0.443273,46.101575],[0.448942,46.096252],[0.445719,46.093661],[0.447289,46.087198],[0.466689,46.087602],[0.475419,46.084605],[0.474123,46.074406],[0.478027,46.068332],[0.48066,46.065434],[0.471099,46.066778],[0.466113,46.060972],[0.446359,46.051238],[0.413294,46.049096],[0.412277,46.052273],[0.402781,46.063135]]]
},
boundaryLayer = L.TileLayer.BoundaryCanvas.createFromLayer(light, {
  boundary: geom, 
  trackAttribution: true
}).addTo(map);



var popmaps = function(feature, layer) {
  var prop = feature.properties,
    popUp = '<h2>' + prop.title + '</h2>' +
    '<div class="desc">' + (prop.description || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="num">' + (prop.phone || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>').replace(/(?:\+33|0)([0-9 ]{3,})/g, '<a href="tel:+33$1">0$1</a>').replace(/0([0-9])([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})/g, '0$1 $2 $3 $4 $5') + '</div>' +
    '<div class="mail">' + (prop.email || '').replace(/([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})/gi, '<a href="mailto:$1">$1</a>') + '</div>' +
    '<div class="web">' + (prop.url || '').replace(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi, '<a href="$1">$1</a>') + '</div>' +
    '<div class="loc">' + (prop.address || '') + '</div>' +
    '<div class="bus">' + (prop.bus || '') + '</div>' +
    '<div class="park">' + (prop.park || '') + '</div>' +
    '<div class="acc">' + (prop.accessible || '') + '</div>' +
    '<div class="fb">' + (prop.facebook || '').replace(/(?:https?:\/\/www\.facebook\.com\/)?@?([a-zé_0-9-.]+)\/?/gi, '<a href="https://www.facebook.com/$1">@$1</a>') + '</div>' +
    '<div class="tw">' + (prop.twitter || '').replace(/(?:https?:\/\/www\.twitter\.com\/)?@?([a-z_0-9-.]+)\/?/gi, '<a href="https://www.twitter.com/$1">@$1</a>') + '</div>' +
    '<div class="ig">' + (prop.instagram || '').replace(/(?:https?:\/\/www\.instagram\.com\/)?@?([a-z_0-9-.]+)\/?/gi, '<a href="https://www.instagram.com/$1">@$1</a>') + '</div>' +
    '<div class="yt">' + (prop.youtube || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="sc">' + (prop.soundcloud || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="prix">' + (prop.prix || '') + '</div>' +
    '<div class="conv">' + (prop.conv || '') + '</div>' +
    '<div class="lng">' + (prop.language || '') + '</div>' +
    '<div class="info">' + (prop.info || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="avis">' + (prop.avis || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>';
  layer.bindPopup(String(popUp));
},
main = L.geoJson(geojson, {
  pointToLayer: function(feature, latlng) {
    var icon = L.divIcon({
      iconSize: [35,35],
      iconAnchor: [17,35],
      className: 'm-' + (feature.properties.category || "default"),
      popupAnchor: [0,0],
      html: '<div class="marker-pin"></div><div class="shadow"></div>'
    });
    return L.marker(latlng, {
      icon: icon,
      riseOnHover: true
    });
  },
  onEachFeature: popmaps
}).addTo(map);

var command = L.control({position: 'topright'});

command.onAdd = function() {
  var div = L.DomUtil.create('div', 'command');
  div.innerHTML += '<h3>Filtrer</h3>'
  + '<label for="exit-command" class="lab"><input type="checkbox" id="exit-command" /></label>'
  + '<label for="m-menses"><input id="m-menses" type="checkbox" class="chk-filter" checked />Boîtes à don menstruelles</label>'
  + '<label for="m-host"><input id="m-host" type="checkbox" class="chk-filter" checked />Hébergement</label>'
  + '<label for="m-testing"><input id="m-testing" type="checkbox" class="chk-filter" checked />Dépistage IST</label>'
  + '<label for="m-doctor"><input id="m-doctor" type="checkbox" class="chk-filter" checked />Soignant&middot;es</label>'
  + '<label for="m-sport"><input id="m-sport" type="checkbox" class="chk-filter" checked />Sport</label>'
  + '<label for="m-activism"><input id="m-activism" type="checkbox" class="chk-filter" checked />Militer</label>'
  + '<label for="m-health"><input id="m-health" type="checkbox" class="chk-filter" checked />Santé</label>'
  + '<label for="m-culture"><input id="m-culture" type="checkbox" class="chk-filter" checked />Culturel</label>'
  + '<label for="m-support"><input id="m-support" type="checkbox" class="chk-filter" checked />Groupe de parole</label>'
  + '<label for="m-official"><input id="m-official" type="checkbox" class="chk-filter" checked />Élues</label>'
  + '<label for="m-solidarity"><input id="m-solidarity" type="checkbox" class="chk-filter" checked />Solidarité</label>'
  + '<label for="m-right"><input id="m-right" type="checkbox" class="chk-filter" checked />Droit & Justice</label>'
  return div;
};
command.addTo(map);

document.addEventListener('click', (e) => {
  if ('chk-filter' == e.target.className) {
    var el = document.getElementsByClassName(e.target.id);
    if (e.target.checked) {
      [...el].forEach(x => (x.style.display = 'block'));
    } else {
      [...el].forEach(x => (x.style.display = 'none'));
    }
  }
  if ('exit-command' == e.target.id) {
    document.querySelector('.command').classList.toggle('hide')
    document.querySelector('.lab').classList.toggle('down')
  }
}, false);
